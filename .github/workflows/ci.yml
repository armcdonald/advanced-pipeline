# =============================================================================
# GitHub Actions CI/CD Pipeline
#
# This workflow demonstrates how to use GitHub Marketplace actions.
# Each 'uses:' line references an action from the Marketplace.
# =============================================================================

# give it a name to start
name: Python CI Pipeline

# Trigger the workflow on push to main branch
on:
  push:
    branches: [main]

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Lint the code
  # ---------------------------------------------------------------------------
  lint:
    name: Code quality check static
    runs-on: ubuntu-latest

    steps:
      # MARKETPLACE ACTION: Checkout repository
      # https://github.com/marketplace/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v6

      # MARKETPLACE ACTION: Setup Python environment
      # https://github.com/marketplace/actions/setup-python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install tools
        run: pip install flake8 black isort

      # Run linters (black will fail with python 3.14)
      - name: Check code formatting with black
        run: black --check --diff src/ tests/

      - name: Check import sorting with isort
        run: isort --check-only --diff src/ tests/

      - name: Lint with flake8
        run: flake8 src/ tests/ --max-line-length=100

  # ---------------------------------------------------------------------------
  # Job 2: Run tests
  # ---------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint # Only run this job if lint job passes

    # Matrix strategy: test on multiple Python versions
    strategy:
      matrix:
        python-version: ["3.12", "3.13", "3.14"]

    steps:
      # MARKETPLACE ACTION: Checkout repository
      # https://github.com/marketplace/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v6

      # MARKETPLACE ACTION: Setup Python environment
      # https://github.com/marketplace/actions/setup-python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
            pip install pytest pytest-cov

      - name: Run code coverage
        run: |
            pytest tests/ -v --cov=src --cov-report=xml --cov-report=term

      # MARKETPLACE ACTION: Upload coverage to Codecov
      # https://github.com/marketplace/actions/codecov
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  # ---------------------------------------------------------------------------
  # Job 3: Security scan
  # ---------------------------------------------------------------------------
  security:
    name: Security scan
    runs-on: ubuntu-latest

    steps:
      # MARKETPLACE ACTION: Checkout repository
      # https://github.com/marketplace/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v6

      # MARKETPLACE ACTION: Setup Python environment
      # https://github.com/marketplace/actions/setup-python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      # MARKETPLACE ACTION: Run Bandit security scanner
      # https://github.com/marketplace/actions/bandit-action
      - name: Install and run bandit
        run: |
            pip install bandit
            bandit -r src/ -ll

  # ---------------------------------------------------------------------------
  # Job 4: Build and create release artifact
  # ---------------------------------------------------------------------------
  build:
    name: Build package
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
      # MARKETPLACE ACTION: Checkout repository
      # https://github.com/marketplace/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v6

      # MARKETPLACE ACTION: Setup Python environment
      # https://github.com/marketplace/actions/setup-python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Install build
        run: pip install build

      - name: Build package
        run: python -m build

      # MARKETPLACE ACTION: Upload build artifacts
      # https://github.com/marketplace/actions/upload-a-build-artifact
      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v6
        with:
          name: python-package
          path: dist/
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Job 5: Create GitHub Release (only on tags)
  # ---------------------------------------------------------------------------
  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, '/refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # MARKETPLACE ACTION: Download artifacts from previous job
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: python-package
          path: dist/

      # MARKETPLACE ACTION: Create GitHub Release
      # https://github.com/marketplace/actions/gh-release
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
